<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage - Northwoods Community Church</title>
    <!-- Brand fonts: Red Rock display font + Myriad Pro with system fallbacks -->
    <style>
        @font-face {
            font-family: 'Red Rock';
            src: url('RedRock.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Myriad Pro';
            src: local('Myriad Pro'), local('MyriadPro-Regular');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Myriad Pro';
            src: local('Myriad Pro Light'), local('MyriadPro-Light');
            font-weight: 300;
            font-style: normal;
        }
        @font-face {
            font-family: 'Myriad Pro';
            src: local('Myriad Pro Semibold'), local('MyriadPro-Semibold');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Myriad Pro';
            src: local('Myriad Pro Bold'), local('MyriadPro-Bold');
            font-weight: 700;
            font-style: normal;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Northwoods Brand Colors */
            --blue-primary: #004C97;      /* Pantone 2945 - Primary Blue */
            --blue-dark: #002855;         /* Pantone 295 - Dark Blue */
            --blue-light: #009CDE;        /* Pantone 292 - Light Blue */
            --blue-tint-72: rgba(0, 156, 222, 0.72);  /* Pantone 292 72% */
            --blue-tint-38: rgba(0, 156, 222, 0.38);  /* Pantone 292 38% */
            --blue-tint-18: rgba(0, 156, 222, 0.18);  /* Pantone 292 18% */
            --gold: #F1BE48;              /* Pantone 142 - Gold */
            --orange: #FF6900;            /* Pantone 1505 - Orange */
            --green: #86AD3F;             /* Pantone 4212 - Green */
            --black: #2D2926;             /* Brand Black */

            /* Applied Colors */
            --primary-color: #004C97;
            --primary-light: #009CDE;
            --primary-dark: #002855;
            --background-dark: #002855;
            --background-card: #003d6b;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --accent-gradient: linear-gradient(135deg, #004C97 0%, #009CDE 100%);
            --accent-gradient-reversed: linear-gradient(135deg, #009CDE 0%, #004C97 100%);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Myriad Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            cursor: none;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 1.5rem;
            gap: 1.5rem;
        }

        /* Main Content - full height layout */
        .main-content {
            flex: 1;
            display: flex;
            gap: 1.5rem;
            overflow: hidden;
            height: 100%;
        }

        /* Slide View (single event spotlight) */
        .slide-view {
            flex: 2;
            background: var(--background-card);
            border-radius: 24px;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        /* Corner elements inside slide view */
        .slide-corner-logo {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slide-corner-logo .logo {
            height: 60px;
            width: auto;
            object-fit: contain;
        }

        .slide-corner-logo .room-filter-badge {
            display: inline-block;
            background: var(--blue-tint-38);
            color: var(--text-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .slide-corner-clock {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 10;
            text-align: right;
        }

        .slide-corner-clock .current-time {
            font-size: 2.75rem;
            font-weight: 300;
            letter-spacing: -0.02em;
        }

        .slide-corner-clock .current-date {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }


        .slide-view.has-background {
            background-size: cover;
            background-position: center;
        }

        .slide-view.has-background::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(12, 24, 33, 0.7);
            z-index: 1;
        }

        .slide-view .slide-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            text-align: center;
            width: 100%;
            height: 100%;
            padding: 2rem;
            transition: opacity 0.4s ease;
        }

        .slide-label {
            display: inline-block;
            background: var(--accent-gradient);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            font-family: 'Myriad Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            height: 2.75rem;
            line-height: 1.5rem;
        }

        .slide-label.happening-now {
            background: var(--accent-gradient);
        }

        .slide-label.upcoming {
            background: var(--blue-tint-18);
            color: var(--text-secondary);
        }

        .slide-title {
            font-family: 'Myriad Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: clamp(3rem, 6vw, 5rem);
            font-weight: 600;
            line-height: 1.15;
            letter-spacing: 0.01em;
            max-width: 85%;
            min-height: 6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-time {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-size: clamp(1.75rem, 3.5vw, 2.75rem);
            height: 3.5rem;
        }

        .slide-time-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            color: var(--primary-light);
        }

        .slide-time-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .slide-location {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 85%;
            min-height: 5rem;
            background: var(--blue-tint-18);
            border: 1px solid var(--blue-tint-38);
            border-radius: 10px;
            overflow: hidden;
        }

        .slide-location-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-primary);
            font-weight: 600;
            background: var(--blue-tint-38);
            padding: 0.45rem 1.25rem;
            width: 100%;
            text-align: center;
        }

        .slide-location-box {
            padding: 1rem 2rem;
            font-size: clamp(1.3rem, 2.5vw, 1.75rem);
            color: var(--text-primary);
            text-align: center;
            line-height: 1.4;
        }

        .slide-description {
            font-size: 1.5rem;
            color: var(--text-secondary);
            line-height: 1.5;
            max-width: 700px;
            min-height: 2.5rem;
        }

        /* Welcome Slide Styles */
        .welcome-slide {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            width: 100%;
        }

        .welcome-slide .welcome-title {
            font-family: 'Red Rock', 'Myriad Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 5rem;
            font-weight: 400;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            letter-spacing: 0.02em;
        }

        .welcome-slide .welcome-subtitle {
            font-size: 2.1rem;
            color: var(--text-secondary);
            max-width: 700px;
        }

        .welcome-slide .welcome-time {
            font-size: 7.5rem;
            font-weight: 200;
            color: var(--text-primary);
        }

        .welcome-slide .welcome-date {
            font-size: 1.8rem;
            color: var(--text-secondary);
            margin-top: 0.6rem;
        }

        /* Events Sidebar - Contains two separate boxes */
        .events-sidebar {
            flex: 0 0 380px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            transition: flex-basis 0.4s ease;
        }

        /* Two-column mode when many events */
        .events-sidebar.two-column {
            flex: 0 0 780px;
        }

        /* Individual section boxes */
        .events-section-box {
            background: var(--background-card);
            border-radius: 20px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .events-section-box.happening-now-box {
            flex: 0 0 auto;
            max-height: 50%;
        }

        .events-section-box.today-events-box {
            flex: 1;
            min-height: 0;
        }

        /* Scroll container within each box */
        .events-scroll-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            transition: transform 0.5s ease;
        }

        /* Two-column grid layout */
        .events-list.two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.85rem;
        }

        .section-title {
            font-family: 'Myriad Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            flex-shrink: 0;
        }

        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--blue-tint-38);
            border-radius: 12px;
            padding: 1rem;
            z-index: 1000;
            color: white;
            font-size: 0.85rem;
            min-width: 280px;
            cursor: default;
        }

        .debug-panel h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--primary-light);
        }

        .debug-slider-group {
            margin-bottom: 1rem;
        }

        .debug-slider-group label {
            display: block;
            margin-bottom: 0.25rem;
        }

        .debug-slider-group input[type="range"] {
            width: 100%;
            margin-bottom: 0.25rem;
        }

        .debug-slider-group .value {
            text-align: right;
            font-weight: 600;
            color: var(--primary-light);
        }

        .debug-panel button {
            width: 100%;
            padding: 0.5rem;
            background: var(--primary-color);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .debug-panel button:hover {
            background: var(--primary-light);
        }

        .no-events-message {
            color: var(--text-primary);
            font-size: 1rem;
            padding: 0.5rem 0;
        }

        .event-card {
            background: var(--blue-tint-18);
            border-radius: 14px;
            padding: 1.25rem 1.25rem;
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary-color);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .event-card.active {
            background: linear-gradient(135deg, var(--blue-tint-38) 0%, var(--background-card) 100%);
            border-left-color: var(--primary-light);
            border-left-width: 6px;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.4);
        }

        .event-card .card-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.1s linear;
        }

        .event-card.announcement {
            border-left-color: var(--gold);
        }

        .event-card.announcement.active {
            background: linear-gradient(135deg, rgba(241, 190, 72, 0.3) 0%, var(--background-card) 100%);
        }

        .event-card.info {
            border-left-color: var(--primary-color);
        }

        .event-card.info.active {
            background: linear-gradient(135deg, var(--blue-tint-38) 0%, var(--background-card) 100%);
            border-left-color: var(--primary-light);
        }

        .events-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .events-divider::before,
        .events-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--blue-tint-38);
        }

        .event-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            line-height: 1.25;
        }

        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            font-size: 0.95rem;
            color: var(--text-primary);
            opacity: 0.85;
        }

        .event-time {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .event-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--blue-tint-18);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .events-sidebar {
                flex: 0 0 auto;
                max-height: 35vh;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .slide-title {
                font-size: 2rem;
            }

            .welcome-slide .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-slide .welcome-time {
                font-size: 4rem;
            }

            .slide-corner-clock .current-time {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Content - Full Height -->
        <main class="main-content">
            <!-- Featured Event Slide -->
            <section class="slide-view" id="slideView">
                <!-- Corner Logo -->
                <div class="slide-corner-logo">
                    <img src="logo.png" alt="Northwoods Community Church" class="logo">
                    <span class="room-filter-badge" id="roomFilterBadge" style="display: none;"></span>
                </div>
                <!-- Corner Clock -->
                <div class="slide-corner-clock">
                    <div class="current-time" id="currentTime">--:--</div>
                    <div class="current-date" id="currentDate">Loading...</div>
                </div>

                <div class="loading" id="loadingState">
                    <div class="loading-spinner"></div>
                </div>
                <div class="slide-content" id="slideContent" style="display: none;">
                    <span class="slide-label" id="slideLabel">Happening Now</span>
                    <h1 class="slide-title" id="slideTitle">Event Name</h1>
                    <div class="slide-time">
                        <svg class="slide-time-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span class="slide-time-value" id="slideTime">12:00 PM - 1:00 PM</span>
                    </div>
                    <div class="slide-location">
                        <span class="slide-location-label">Location</span>
                        <div class="slide-location-box" id="slideLocation">Location</div>
                    </div>
                    <p class="slide-description" id="slideDescription"></p>
                </div>
            </section>

            <!-- Events Sidebar - Two separate boxes -->
            <aside class="events-sidebar" id="eventsSidebar">
                <!-- Happening Now Box -->
                <div class="events-section-box happening-now-box" id="happeningNowBox">
                    <h2 class="section-title">Happening Now</h2>
                    <div class="events-scroll-container">
                        <div class="events-list" id="happeningNowList">
                            <!-- Happening now events will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Today's Events Box -->
                <div class="events-section-box today-events-box" id="todayEventsBox">
                    <h2 class="section-title">Today's Events</h2>
                    <div class="events-scroll-container">
                        <div class="events-list" id="todayEventsList">
                            <!-- Today's events will be populated here -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Debug Panel (only shown in debug mode) -->
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <h3>Debug Mode</h3>
        <div class="debug-slider-group">
            <label>Happening Now Events</label>
            <input type="range" id="debugHappeningSlider" min="0" max="15" value="2">
            <div class="value" id="debugHappeningValue">2</div>
        </div>
        <div class="debug-slider-group">
            <label>Upcoming Events</label>
            <input type="range" id="debugUpcomingSlider" min="0" max="20" value="4">
            <div class="value" id="debugUpcomingValue">4</div>
        </div>
        <button id="debugApplyBtn">Apply Changes</button>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiUrl: '/api/events', // Proxied through local server to avoid CORS
            slideInterval: 8000, // 8 seconds per slide
            refreshInterval: 600000, // 10 minutes
        };

        // Get room filter from URL parameter (e.g., ?room=Auditorium)
        function getRoomFilter() {
            const params = new URLSearchParams(window.location.search);
            return params.get('room');
        }

        // Check for debug mode (e.g., ?debug=true)
        function isDebugMode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('debug') === 'true';
        }

        const ROOM_FILTER = getRoomFilter();
        const DEBUG_MODE = isDebugMode();

        // Debug state
        let debugHappeningNow = 2;
        let debugUpcoming = 4;

        // Default welcome slides when no events
        const WELCOME_SLIDES = [
            {
                type: 'welcome',
                title: 'Welcome to Northwoods',
                subtitle: ''
            },
            {
                type: 'info',
                title: 'Need Assistance?',
                subtitle: 'Please visit the information desk'
            },
            {
                type: 'time',
                title: '',
                subtitle: ''
            }
        ];

        // State
        let events = [];
        let currentSlideIndex = 0;
        let slideTimer = null;
        let progressTimer = null;
        let progressValue = 0;
        let isShowingWelcome = false;
        let lastHappeningCount = 0;
        let lastUpcomingCount = 0;

        // DOM Elements
        const elements = {
            currentTime: document.getElementById('currentTime'),
            currentDate: document.getElementById('currentDate'),
            loadingState: document.getElementById('loadingState'),
            slideContent: document.getElementById('slideContent'),
            slideView: document.getElementById('slideView'),
            slideLabel: document.getElementById('slideLabel'),
            slideTitle: document.getElementById('slideTitle'),
            slideLocation: document.getElementById('slideLocation'),
            slideTime: document.getElementById('slideTime'),
            slideDescription: document.getElementById('slideDescription'),
            happeningNowBox: document.getElementById('happeningNowBox'),
            happeningNowList: document.getElementById('happeningNowList'),
            todayEventsBox: document.getElementById('todayEventsBox'),
            todayEventsList: document.getElementById('todayEventsList')
        };

        // Parse .NET date format - API sends local time encoded as UTC timestamp
        function parseNetDate(dateString) {
            if (!dateString) return null;
            const match = dateString.match(/\/Date\((\d+)([+-]\d{4})?\)\//);
            if (match) {
                const timestamp = parseInt(match[1]);
                // The API sends local time as if it were UTC, so we need to
                // interpret it as local time by adding back the timezone offset
                const utcDate = new Date(timestamp);
                const localDate = new Date(
                    utcDate.getUTCFullYear(),
                    utcDate.getUTCMonth(),
                    utcDate.getUTCDate(),
                    utcDate.getUTCHours(),
                    utcDate.getUTCMinutes(),
                    utcDate.getUTCSeconds()
                );
                return localDate;
            }
            return new Date(dateString);
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Check if date is today
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // Check if date is tomorrow
        function isTomorrow(date) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return date.toDateString() === tomorrow.toDateString();
        }

        // Get relative date label
        function getDateLabel(date) {
            if (isToday(date)) return 'Today';
            if (isTomorrow(date)) return 'Tomorrow';
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        // Update clock
        function updateClock() {
            const now = new Date();
            elements.currentTime.textContent = formatTime(now);
            elements.currentDate.textContent = formatDate(now);
        }

        // Check if event matches room filter (case-insensitive partial match)
        function matchesRoomFilter(event) {
            if (!ROOM_FILTER) return true;
            const spaces = (event.SpacesToDisplay || '').toLowerCase();
            return spaces.includes(ROOM_FILTER.toLowerCase());
        }

        // Fetch events from API
        async function fetchEvents() {
            try {
                const response = await fetch(CONFIG.apiUrl);
                const data = await response.json();

                // Filter out hidden events, apply room filter, and sort by start time
                events = data
                    .filter(e => !e.IsHiddenFromDisplay)
                    .map(e => ({
                        ...e,
                        startDate: parseNetDate(e.EventStart),
                        endDate: parseNetDate(e.EventEnd)
                    }))
                    .filter(matchesRoomFilter)
                    .sort((a, b) => a.startDate - b.startDate);

                renderEvents();
            } catch (error) {
                console.error('Error fetching events:', error);
                events = [];
                renderEvents();
            }
        }

        // Scroll the events list to show the active card (only if event count >= SCROLL_THRESHOLD)
        function scrollToActiveCard(happeningCount, upcomingCount) {
            // Check both lists for active card
            const lists = [
                { wrapper: elements.happeningNowBox?.querySelector('.events-scroll-container'), list: elements.happeningNowList, count: happeningCount },
                { wrapper: elements.todayEventsBox?.querySelector('.events-scroll-container'), list: elements.todayEventsList, count: upcomingCount }
            ];

            lists.forEach(({ wrapper, list, count }) => {
                if (!wrapper || !list) return;

                // Only scroll if count meets threshold
                if (count < SCROLL_THRESHOLD) {
                    list.style.transform = 'translateY(0)';
                    return;
                }

                const activeCard = list.querySelector('.event-card.active');
                const wrapperHeight = wrapper.offsetHeight;
                const listHeight = list.offsetHeight;

                // If list fits without scrolling, don't scroll
                if (listHeight <= wrapperHeight) {
                    list.style.transform = 'translateY(0)';
                    return;
                }

                if (!activeCard) {
                    list.style.transform = 'translateY(0)';
                    return;
                }

                const cardTop = activeCard.offsetTop;
                const cardHeight = activeCard.offsetHeight;

                // Calculate scroll position to center the active card
                const scrollTarget = cardTop - (wrapperHeight / 2) + (cardHeight / 2);

                // Clamp scroll to valid range
                const maxScroll = listHeight - wrapperHeight;
                const clampedScroll = Math.max(0, Math.min(scrollTarget, maxScroll));

                list.style.transform = `translateY(-${clampedScroll}px)`;
            });
        }

        // Render welcome slide
        function renderWelcomeSlide() {
            isShowingWelcome = true;
            const slideIndex = currentSlideIndex % WELCOME_SLIDES.length;
            const slide = WELCOME_SLIDES[slideIndex];
            const now = new Date();

            elements.slideContent.style.opacity = '0';

            setTimeout(() => {
                if (slide.type === 'time') {
                    elements.slideContent.innerHTML = `
                        <div class="welcome-slide">
                            <div class="welcome-time">${formatTime(now)}</div>
                            <div class="welcome-date">${formatDate(now)}</div>
                        </div>
                    `;
                } else {
                    elements.slideContent.innerHTML = `
                        <div class="welcome-slide">
                            <h1 class="welcome-title">${slide.title}</h1>
                            <p class="welcome-subtitle">${slide.subtitle}</p>
                        </div>
                    `;
                }

                elements.loadingState.style.display = 'none';
                elements.slideContent.style.display = 'flex';
                elements.slideContent.style.opacity = '1';
            }, 300);

            // Show "No events" in sidebar when showing welcome slides
            elements.happeningNowBox.style.display = 'flex';
            elements.happeningNowList.innerHTML = '<div class="no-events-message">No events currently happening</div>';
            elements.todayEventsList.innerHTML = '<div class="no-events-message">No events scheduled</div>';
        }

        // Render the featured slide
        function renderSlide() {
            if (events.length === 0) {
                renderWelcomeSlide();
                return;
            }

            isShowingWelcome = false;
            const eventIndex = currentSlideIndex % events.length;
            const event = events[eventIndex];

            // Fade out content
            elements.slideContent.style.opacity = '0';

            setTimeout(() => {
                // Ensure we have the event slide structure (not welcome slide)
                if (!document.getElementById('slideLabel')) {
                    elements.slideContent.innerHTML = `
                        <span class="slide-label" id="slideLabel">Happening Now</span>
                        <h1 class="slide-title" id="slideTitle">Event Name</h1>
                        <div class="slide-time">
                            <svg class="slide-time-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span class="slide-time-value" id="slideTime">12:00 PM - 1:00 PM</span>
                        </div>
                        <div class="slide-location">
                            <span class="slide-location-label">Location</span>
                            <div class="slide-location-box" id="slideLocation">Location</div>
                        </div>
                        <p class="slide-description" id="slideDescription"></p>
                    `;
                }

                // Get elements
                const slideLabel = document.getElementById('slideLabel');
                const slideTitle = document.getElementById('slideTitle');
                const slideLocation = document.getElementById('slideLocation');
                const slideTime = document.getElementById('slideTime');
                const slideDescription = document.getElementById('slideDescription');

                // Update content
                slideTitle.textContent = event.DisplayName || event.EventName;
                slideLocation.textContent = event.SpacesToDisplay || 'TBD';
                slideTime.textContent = event.EventTimeDisplay || `${formatTime(event.startDate)} - ${formatTime(event.endDate)}`;
                slideDescription.textContent = event.Description || '';
                slideDescription.style.display = event.Description ? 'block' : 'none';

                // Update label
                const now = new Date();
                slideLabel.classList.remove('happening-now', 'upcoming');
                if (event.IsAnnouncement) {
                    slideLabel.textContent = 'Announcement';
                    slideLabel.classList.add('happening-now');
                } else if (event.startDate <= now && event.endDate >= now) {
                    slideLabel.textContent = 'Happening Now';
                    slideLabel.classList.add('happening-now');
                } else {
                    slideLabel.textContent = 'Upcoming';
                    slideLabel.classList.add('upcoming');
                }

                // Handle background
                if (event.BackgroundfileUrl) {
                    elements.slideView.style.backgroundImage = `url(${event.BackgroundfileUrl})`;
                    elements.slideView.classList.add('has-background');
                } else {
                    elements.slideView.style.backgroundImage = '';
                    elements.slideView.classList.remove('has-background');
                }

                // Show content
                elements.loadingState.style.display = 'none';
                elements.slideContent.style.display = 'flex';
                elements.slideContent.style.opacity = '1';
            }, 300);
        }

        // Thresholds for layout and scrolling
        const TWO_COLUMN_THRESHOLD = 4;  // Switch to two columns at 4+ events
        const SCROLL_THRESHOLD = 7;       // Start scrolling at 7+ events
        const FAST_SPEED_THRESHOLD = 7;   // Double speed at 7+ events in either section

        // Render events sidebar with two separate boxes
        function renderUpcomingEvents() {
            const sidebar = document.getElementById('eventsSidebar');

            if (events.length === 0) {
                elements.happeningNowBox.style.display = 'flex';
                elements.happeningNowList.innerHTML = '<div class="no-events-message">No events currently happening</div>';
                elements.todayEventsList.innerHTML = '<div class="no-events-message">No events scheduled</div>';
                elements.happeningNowList.classList.remove('two-column');
                elements.todayEventsList.classList.remove('two-column');
                sidebar.classList.remove('two-column');
                return;
            }

            const now = new Date();
            const activeIndex = currentSlideIndex % events.length;

            // Split events into happening now vs upcoming
            const happeningNow = events.filter(e =>
                e.startDate <= now && e.endDate >= now && !e.IsAnnouncement
            );
            const upcoming = events.filter(e =>
                (e.startDate > now || e.IsAnnouncement)
            );

            // Determine if we need two columns for each section
            const useTwoColumnsHappening = happeningNow.length >= TWO_COLUMN_THRESHOLD;
            const useTwoColumnsUpcoming = upcoming.length >= TWO_COLUMN_THRESHOLD;
            const useTwoColumns = useTwoColumnsHappening || useTwoColumnsUpcoming;

            // Apply two-column class to sidebar for width
            if (useTwoColumns) {
                sidebar.classList.add('two-column');
            } else {
                sidebar.classList.remove('two-column');
            }

            // Render Happening Now box (always visible)
            elements.happeningNowBox.style.display = 'flex';

            if (happeningNow.length > 0) {
                if (useTwoColumnsHappening) {
                    elements.happeningNowList.classList.add('two-column');
                } else {
                    elements.happeningNowList.classList.remove('two-column');
                }

                let happeningHtml = '';
                happeningNow.forEach((event) => {
                    const globalIndex = events.indexOf(event);
                    const isActive = globalIndex === activeIndex;
                    happeningHtml += `
                        <div class="event-card ${event.IsAnnouncement ? 'announcement' : ''} ${isActive ? 'active' : ''}">
                            <div class="event-name">${event.DisplayName || event.EventName}</div>
                            <div class="event-meta">
                                <div class="event-time">${event.EventTimeDisplay || formatTime(event.startDate)}</div>
                                ${event.SpacesToDisplay ? `<div class="event-location">${event.SpacesToDisplay}</div>` : ''}
                            </div>
                            ${isActive ? '<div class="card-progress" id="cardProgress"></div>' : ''}
                        </div>
                    `;
                });
                elements.happeningNowList.innerHTML = happeningHtml;
            } else {
                elements.happeningNowList.classList.remove('two-column');
                elements.happeningNowList.innerHTML = '<div class="no-events-message">No events currently happening</div>';
            }

            // Render Today's Events (upcoming) box
            if (useTwoColumnsUpcoming) {
                elements.todayEventsList.classList.add('two-column');
            } else {
                elements.todayEventsList.classList.remove('two-column');
            }

            let upcomingHtml = '';
            if (upcoming.length > 0) {
                upcoming.forEach((event) => {
                    const globalIndex = events.indexOf(event);
                    const isActive = globalIndex === activeIndex;
                    upcomingHtml += `
                        <div class="event-card ${event.IsAnnouncement ? 'announcement' : ''} ${isActive ? 'active' : ''}">
                            <div class="event-name">${event.DisplayName || event.EventName}</div>
                            <div class="event-meta">
                                <div class="event-time">${event.EventTimeDisplay || formatTime(event.startDate)}</div>
                                ${event.SpacesToDisplay ? `<div class="event-location">${event.SpacesToDisplay}</div>` : ''}
                            </div>
                            ${isActive ? '<div class="card-progress" id="cardProgress"></div>' : ''}
                        </div>
                    `;
                });
            } else {
                upcomingHtml = '<div class="no-events-message">No upcoming events</div>';
            }
            elements.todayEventsList.innerHTML = upcomingHtml;

            // Store counts for speed adjustment
            lastHappeningCount = happeningNow.length;
            lastUpcomingCount = upcoming.length;

            // Scroll to center the active card (only if count meets threshold)
            setTimeout(() => scrollToActiveCard(happeningNow.length, upcoming.length), 50);
        }

        // Render all events
        function renderEvents() {
            renderSlide();
            renderUpcomingEvents();
        }

        // Update progress bar on active card
        function updateCardProgress() {
            const progressBar = document.getElementById('cardProgress');
            if (progressBar) {
                progressBar.style.transform = `scaleX(${Math.min(progressValue, 100) / 100})`;
            }
        }

        // Get effective slide interval (halved if 8+ events in either section)
        function getEffectiveSlideInterval() {
            if (lastHappeningCount >= FAST_SPEED_THRESHOLD || lastUpcomingCount >= FAST_SPEED_THRESHOLD) {
                return CONFIG.slideInterval / 2;
            }
            return CONFIG.slideInterval;
        }

        // Start slide rotation
        function startSlideRotation() {
            // Clear existing timers
            if (slideTimer) clearInterval(slideTimer);
            if (progressTimer) clearInterval(progressTimer);

            // Reset progress
            progressValue = 0;
            updateCardProgress();

            const interval = getEffectiveSlideInterval();

            // Progress bar animation
            progressTimer = setInterval(() => {
                progressValue += (100 / (interval / 100));
                updateCardProgress();
            }, 100);

            // Slide rotation
            slideTimer = setInterval(() => {
                currentSlideIndex++;
                progressValue = 0;
                renderEvents();
                // Restart rotation with potentially new interval
                startSlideRotation();
            }, interval);
        }

        // Generate fake events for debug mode
        function generateDebugEvents(happeningCount, upcomingCount) {
            const now = new Date();
            const fakeEvents = [];
            const rooms = ['Auditorium', 'Room 101', 'Fellowship Hall', 'Chapel', 'Youth Room', 'Conference Room A', 'Lobby'];
            const eventNames = [
                'Sunday Service', 'Youth Group', 'Bible Study', 'Prayer Meeting',
                'Choir Practice', 'Staff Meeting', 'Community Lunch', 'Kids Church',
                'Marriage Workshop', 'New Members Class', 'Volunteer Training',
                'Board Meeting', 'Worship Night', 'Small Group', 'Recovery Group'
            ];

            // Generate "happening now" events
            for (let i = 0; i < happeningCount; i++) {
                const startTime = new Date(now.getTime() - (30 + i * 15) * 60000);
                const endTime = new Date(now.getTime() + (60 + i * 15) * 60000);
                fakeEvents.push({
                    EventName: eventNames[i % eventNames.length],
                    DisplayName: eventNames[i % eventNames.length],
                    SpacesToDisplay: rooms[i % rooms.length],
                    EventStart: `/Date(${startTime.getTime()})/`,
                    EventEnd: `/Date(${endTime.getTime()})/`,
                    EventTimeDisplay: `${formatTime(startTime)} - ${formatTime(endTime)}`,
                    IsAnnouncement: false,
                    IsHiddenFromDisplay: false,
                    startDate: startTime,
                    endDate: endTime
                });
            }

            // Generate "upcoming" events
            for (let i = 0; i < upcomingCount; i++) {
                const startTime = new Date(now.getTime() + (30 + i * 45) * 60000);
                const endTime = new Date(startTime.getTime() + 60 * 60000);
                const nameIndex = (happeningCount + i) % eventNames.length;
                fakeEvents.push({
                    EventName: eventNames[nameIndex],
                    DisplayName: eventNames[nameIndex],
                    SpacesToDisplay: rooms[(happeningCount + i) % rooms.length],
                    EventStart: `/Date(${startTime.getTime()})/`,
                    EventEnd: `/Date(${endTime.getTime()})/`,
                    EventTimeDisplay: `${formatTime(startTime)} - ${formatTime(endTime)}`,
                    IsAnnouncement: false,
                    IsHiddenFromDisplay: false,
                    startDate: startTime,
                    endDate: endTime
                });
            }

            return fakeEvents.sort((a, b) => a.startDate - b.startDate);
        }

        // Initialize debug panel
        function initDebugPanel() {
            const panel = document.getElementById('debugPanel');
            const happeningSlider = document.getElementById('debugHappeningSlider');
            const upcomingSlider = document.getElementById('debugUpcomingSlider');
            const happeningValue = document.getElementById('debugHappeningValue');
            const upcomingValue = document.getElementById('debugUpcomingValue');
            const applyBtn = document.getElementById('debugApplyBtn');

            panel.style.display = 'block';
            document.body.style.cursor = 'default';

            happeningSlider.addEventListener('input', () => {
                happeningValue.textContent = happeningSlider.value;
            });

            upcomingSlider.addEventListener('input', () => {
                upcomingValue.textContent = upcomingSlider.value;
            });

            applyBtn.addEventListener('click', () => {
                debugHappeningNow = parseInt(happeningSlider.value);
                debugUpcoming = parseInt(upcomingSlider.value);
                events = generateDebugEvents(debugHappeningNow, debugUpcoming);
                currentSlideIndex = 0;
                renderEvents();
                startSlideRotation();
            });

            // Generate initial debug events
            events = generateDebugEvents(debugHappeningNow, debugUpcoming);
        }

        // Initialize
        async function init() {
            // Show room filter badge if filtering
            if (ROOM_FILTER) {
                const badge = document.getElementById('roomFilterBadge');
                badge.textContent = ROOM_FILTER;
                badge.style.display = 'inline-block';
            }

            // Start clock
            updateClock();
            setInterval(updateClock, 1000);

            // Debug mode or normal mode
            if (DEBUG_MODE) {
                initDebugPanel();
                renderEvents();
            } else {
                // Fetch initial events
                await fetchEvents();
                // Periodic refresh
                setInterval(fetchEvents, CONFIG.refreshInterval);
            }

            // Start slide rotation
            startSlideRotation();

            // Hide cursor after inactivity (unless debug mode)
            if (!DEBUG_MODE) {
                let cursorTimeout;
                document.addEventListener('mousemove', () => {
                    document.body.style.cursor = 'default';
                    clearTimeout(cursorTimeout);
                    cursorTimeout = setTimeout(() => {
                        document.body.style.cursor = 'none';
                    }, 2000);
                });
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>
